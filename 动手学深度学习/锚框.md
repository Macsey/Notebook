
## 1. 核心概念与背景
- **定义**：锚框是目标检测算法（如SSD）中用于**区域采样**的预定义边界框。
- **生成方式**：以输入图像的每个像素为中心，生成多个不同**缩放比 (Scale)** 和 **宽高比 (Aspect Ratio)** 的矩形框。
- **作用**：
    1. 作为预测的基准（Reference）。
    2. 判断区域内是否包含目标。
    3. 提供位置调整的基础，预测真实边界框（Ground-truth Bounding Box）。

## 2. 关键技术模块

### 2.1 锚框生成

为了平衡覆盖率与计算量，通常采用稀疏生成策略。

- **参数设定**：
    
    - 输入：图像高 $h$，宽 $w$。
        
    - 缩放比列表：$s \in [s_1, ...]$ （如 $[0.75, 0.5, 0.25]$）。
        
    - 宽高比列表：$r \in [r_1, ...]$ （如 $[1, 2, 0.5]$）。
        
- **数量优化**：
    
    - 不组合所有 $s$ 和 $r$，仅保留包含 $s_1$ 或 $r_1$ 的组合。
        
    - 单像素锚框数：$n + m - 1$ （$n$为缩放比数量，$m$为宽高比数量）。
        
    - **全图锚框总数**：$w \times h \times (n + m - 1)$。
        
- 尺寸计算公式：
    
    $$w_{anchor} = h \times s \times \sqrt{r}$$
    
    $$h_{anchor} = h \times s / \sqrt{r}$$
    
- **输出形状**：`(批量大小, 锚框总数, 4)`，坐标归一化到 $[0, 1]$。
    

### 2.2 相似度度量：交并比 (IoU)

用于衡量锚框与真实边界框的重合程度。

- 公式 (Jaccard系数)：
    
    $$IoU(A, B) = \frac{|A \cap B|}{|A \cup B|}$$
    
- **取值**：$[0, 1]$，0为无重叠，1为完全重合。
    
- **计算技巧**：
    
    - 交集左上角：$\max(x_{min}^A, x_{min}^B), \max(y_{min}^A, y_{min}^B)$
        
    - 交集右下角：$\min(x_{max}^A, x_{max}^B), \min(y_{max}^A, y_{max}^B)$
        
    - 若左上角 > 右下角，则面积为0。
        

---

## 3. 训练阶段：锚框标注 

训练目标检测模型时，需要教会模型每个锚框“是什么”以及“怎么调”。

### 3.1 真实边界框分配逻辑

建立锚框（Anchors）与真实框（Ground Truth, GT）的映射关系：

1. **最大匹配优先**：找出IoU最大的(Anchor, GT)对，强制分配，确保每个GT至少有一个Anchor对应。
    
2. **阈值匹配**：对剩余Anchor，若与某GT的IoU > 阈值（如0.5），则分配该GT。
    
3. **背景标记**：剩余未分配的Anchor标记为背景（类标为0）。

### 3.2 标签生成

- **类别标签 (Class)**：
    
    - 正样本：对应GT的类别索引（从1开始）。
        
    - 负样本（背景）：0。
        
- **偏移量标签 (Offset)**：
    
    - 仅对**正样本**计算，背景的偏移量无效。
        
    - **变换公式**（使分布更均匀）：
        
        - 中心坐标偏移：$10 \times \frac{x_{gt} - x_{anchor}}{w_{anchor}}$
            
        - 宽高比偏移：$5 \times \log(\frac{w_{gt}}{w_{anchor}})$
            
- **掩码 (Mask)**：
    
    - 用于损失函数计算。正样本Mask为1，负样本Mask为0（不计算回归损失）。
        

---

## 4. 预测阶段：后处理 (`multibox_detection`)

模型输出大量重叠框，需通过**非极大值抑制 (NMS)** 进行筛选。

### NMS 算法流程

1. **排序**：将所有预测框按**置信度**（预测概率）从高到低排序。
    
2. **循环抑制**：
    
    - 选中置信度最高的框 $B$ 作为基准。
        
    - 遍历剩余框，若与 $B$ 的 IoU > 阈值（如0.5），则视为重复框并移除。
        
    - 对剩余框重复此过程。
        
3. **输出**：保留下来的框即为最终预测结果。
    

### 输出格式

`(批量大小, 锚框数量, 6)`

- 6个维度：[类别索引, 置信度, xmin, ymin, xmax, ymax]
    
- 背景类或被NMS抑制的框通常标记为 -1。
    

---

## 5. 核心逻辑总结图解

|**阶段**|**核心任务**|**关键函数/算法**|**输入**|**输出**|
|---|---|---|---|---|
|**生成**|制造大量候选框|`multibox_prior`|图像尺寸、s列表、r列表|归一化坐标的锚框列表|
|**度量**|计算框的重合度|`box_iou`|框A列表, 框B列表|IoU矩阵|
|**训练**|贴标签(类+偏移)|`assign_anchor` -> `multibox_target`|锚框, 真实框|类别标签, 偏移量标签, 掩码|
|**预测**|去重叠、选最优|NMS (`multibox_detection`)|预测概率, 预测偏移, 锚框|最终检测框 (含置信度)|

---

## 6. 扩展思考

- **Soft-NMS**：NMS的改进版。不直接删除重叠框，而是降低其置信度，避免在物体极其密集（如两人并排）时误删正确的目标框。
    
- **超参数敏感性**：锚框的`sizes`和`ratios`设置对模型性能至关重要，通常需要根据数据集目标的统计特征（如聚类分析）来设定。