## 一、 为什么要用“多尺度”？

### 1. 朴素方法的痛点

如果在原始图像的**每一个像素**上都生成不同形状的锚框：

- **计算灾难**：以 $561 \times 728$ 的图像为例，若每个像素生成 5 个锚框，总数超过 200 万个。
- **冗余严重**：相邻像素生成的锚框高度重叠，且大部分是背景。

### 2. 解决方案：分层采样

利用卷积神经网络（CNN）的特性，在**不同尺寸的特征图（Feature Map）**上生成锚框：

- **小特征图**：对应原图的感受野大，用来检测**大物体**（数量少，稀疏）。
- **大特征图**：对应原图的感受野小，用来检测**小物体**（数量多，密集）。



## 二、 核心机制：特征图与锚框的映射

### 1. 锚框生成逻辑

我们不再在原图上生成锚框，而是在 CNN 输出的**特征图**上生成。假设特征图形状为 $h \times w$：

- **映射关系**：特征图上的一个像素 $(x, y)$，映射回原图就是一片区域的中心。
- **数量分配**：
    - 特征图越**小**（如 $1 \times 1$） $\rightarrow$ 锚框尺寸**大** $\rightarrow$ 覆盖全图。
    - 特征图越**大**（如 $4 \times 4$） $\rightarrow$ 锚框尺寸**小** $\rightarrow$ 捕捉细节。

### 2. 案例演示 

以输入图像 $561 \times 728$ 为例，不同层级的表现如下表：

|**特征图尺寸 (h×w)**|**锚框尺度 (s)**|**锚框分布**|**适用目标**|
|---|---|---|---|
|**$4 \times 4$** (浅层/大图)|$0.15$ (小)|密集均匀分布 (4行4列)|**小目标** (如远处的物体)|
|**$2 \times 2$** (中层/中图)|$0.4$ (中)|较稀疏，部分重叠|**中等目标**|
|**$1 \times 1$** (深层/小图)|$0.8$ (大)|中心重合，覆盖全图|**大目标** (占据主体)|

> **关键代码逻辑**：`display_anchors` 内部调用了 `multibox_prior`，核心在于根据特征图的宽高比，计算出锚框中心在原图中的相对坐标。

---

## 三、 多尺度检测原理

### 1. 感受野 (Receptive Field)

- **定义**：特征图上一个点对应原图上多大的区域。
- **层级关系**：
    - **靠近输出层 (深层)**：经过多次卷积和池化，感受野**宽广**，包含全局信息 $\rightarrow$ 预测大锚框。
    - **靠近输入层 (浅层)**：卷积次数少，感受野**狭窄**，包含局部纹理细节 $\rightarrow$ 预测小锚框。

### 2. 预测流程

假设我们在某一层得到了 $c$ 张 $h \times w$ 的特征图（即通道数为 $c$）：
1. **生成**：在该层的每个像素位置生成 $a$ 个锚框。
2. **预测**：利用该位置的 $c$ 个通道的数值，预测这 $a$ 个锚框的：
    - **类别 (Class)**：是猫、狗还是背景？
    - **偏移量 (Offset)**：距离真实框微调多少？